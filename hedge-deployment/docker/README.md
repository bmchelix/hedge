# Deploy IoT Edge/Hedge in a docker environment
### 1.	Pre-requisites
a.  Install docker \
b.  Configure docker-bridge \
c.  Configure size of log files (optional) \
d.  Login to docker registry \
e.  Check if whiptail is installed \
f.  Check if jq is installed \
g.  Configure /etc/hosts

#### a.	Install docker
Follow docker install instructions by selecting your host OS from https://docs.docker.com/engine/install/

#### b.	Configure docker-bridge:
1.  Stop docker: `sudo service docker stop` or `sudo systemctl stop docker` 
2.	Create daemon.json at /etc/docker/daemon.json with content:
  ```
    {
        "bip": "10.104.0.1/24",
        "fixed-cidr": "10.104.0.0/24",
        "default-address-pools":
        [
            { "base":"10.104.1.0/16","size":24 }
        ]
    }
  ```
3.	Start docker: `sudo systemctl start docker` or `sudo service docker start`
4.	Make sure docker0 bridge IP is 10.104.0.x using the 'ifconfig' command

#### c.	Configure size of log-files (optional):
To set the size of log files generated by docker containers:
1.	Stop docker service by running `sudo service docker stop` or `sudo systemctl stop docker`
2.	Update the daemon.json file at /etc/docker/daemon.json 
  ```
    {
        "bip": "10.104.0.1/24",
        "fixed-cidr": "10.104.0.0/24",
        "default-address-pools":
        [
            { "base":"10.104.1.0/16","size":24 }
        ],
        "log-driver":"json-file",
        "log-opts": {"max-size":"30m", "max-file":"3"}
    }
  ```
3.	Start docker service by running `sudo systemctl start docker` or `sudo service docker start`.

#### d. Login to docker registry hub.docker.com (Optional)
You must have a username and password with appropriate permission to access docker registry hub.docker.com

Login to the docker registry hub.docker.com to be able to pull docker images in the following steps
```
docker login 
```

Enter your username and password for the docker registry.

You should get a "Login succeeded" message if your authentication is successful.        

#### e. Check if whiptail is installed.
Run the following command:
```
command -v whiptail >/dev/null 2>&1 && echo "Installed" || echo "Not installed"
```
If the output says "Not Installed" then follow relevant install instructions for your platform - https://github.com/domdfcoding/whiptail?tab=readme-ov-file#installation

#### f. Check if jq is installed
Run the following command:
```
command -v jq >/dev/null 2>&1 && echo "Installed" || echo "Not installed"
```
If the output says "Not Installed" then follow relevant install instructions for your platform - https://jqlang.github.io/jq/download/

#### g. Configure /etc/hosts
1. Open `/etc/hosts` file in an editor of choice
2. Remove or comment out all entries for 127.0.0.1 and 127.0.1.1
  ```
  ## 127.0.0.1 localhost
  ```
3. Add the following as a new line
  ```
  127.0.0.1 hedge-secret-bootstrapper edgex-security-bootstrapper hedge-init edgex-security-secretstore-setup edgex-core-common-config-bootstrapper edgex-core-consul edgex-vault edgex-redis edgex-support-notifications edgex-core-metadata hedge-admin hedge-device-extensions meta-sync hedge-event-publisher hedge-remediate nats-proxy edgex-mqtt-broker edgex-security-proxy-setup edgex-nats-server auth-proxy edgex-nginx hedge-elasticsearch hedge-victoria-metrics hedge-db hedge-user-app-mgmt hedge-ml-management export-biz-data hedge-export hedge-event hedge-ui-server hedge-grafana hedge-init hedge-node-red edgex-kuiper edgex-core-command data-enrichment metadata-notifier hedge-ml-edge-agent hedge-ml-broker hedge-ml-pred-anomaly-autoencoder hedge-ml-pred-classification-randomforest hedge-ml-pred-timeseries-multivariate-deepvar hedge-ml-pred-regression-lightgbm device-virtual
  ```

### 2. Copy and extract Hedge installers
a. Copy node installer `hedge-node.tgz` \
b. Extract the installer file: `tar -zxvf hedge-node.tgz`
    
### 3. Configure deployment scripts 
a. **Update `.env` file with your environment specific details:** \

```
CURRENT_HEDGE_NODE_SERVER_NAME=clm-xxx-xxxxxx
CURRENT_HEDGE_NODE_SERVER_DOMAIN_NAME=.mydomain.com
CURRENT_HEDGE_NODE_SERVER_IP=X.X.X.X
``` 
Replace clm-xxx-xxxxxx with the public hostname of the current machine. \
Replace .mydomain.com with the domainname of the current machine \
Replace X.X.X.X with IP address of the current machine.

<br>

```
REMOTE_HEDGE_CORE_SERVER_NAME=clm-yyy-yyyyyy
REMOTE_HEDGE_CORE_DOMAIN_NAME=.mycoredomain.com
REMOTE_HEDGE_CORE_SERVER_IP=Y.Y.Y.Y
```
Replace clm-yyy-yyyyyy with the public hostname of the remote Hedge Core machine. \
Replace .mycoredomain.com with the domain name of the remote Hedge Core machine \
Replace Y.Y.Y.Y with IP address of the remote Hedge Core machine

<br>

b. **Update `.env-core` file with your environment specific details:** \
```
```
Replace all `TODO_` items with the specific tokens and values.

c. **Copy Hedge secret files from the CORE deployment**

When setting up a Helix IoT Edge NODE environment, make sure to copy the `.mqttencpwd` and `.cnslenctok` files from CORE to NODE's `/tmp/` directory.

If CORE is on Kubernetes, then copy this file from the NFS share. More details under Kubernetes Readme


### 4. Bring your own CA SSL to nginx
```
a. Update the hedge/docker-deployment/docker/.env the following vars:
    CERT_PATH=/etc/ssl/ssl_cert.pem
    KEY_PATH=/etc/ssl/ssl_key.pem
    DOMAIN=my.domain.com

### 5. Start the Hedge stack

To start the new stack, run this command: \

To start a CORE+NODE setup with only mandatory services
> `make run ENV=CORE`

To start a NODE only setup with only mandatory services
> `make run ENV=NODE`


\
**[Optional]** By default, only the mandatory hedge services are installed. If you need to install the optional services and run as CORE, then run:

> `make run [ENV=CORE] PROFILE=<profiles>`

PROFILE parameter accepts one or more comma separated profiles: `all,virtual,demo,es,vm,biz`
* **all**: installs all optional services (this doesn't require any additional profile names)
* **virtual**: installs Virtual device service
* **demo**: installs all demo related services and pumps in demo data
* **es**: installs Elasticsearch
* **vm**: installs Victoria Metrics
* **biz**: install Export Biz Data 

**NOTE: Make sure CURRENT_HEDGE_NODE_TYPE is appropriately set in .env** \
**Also make sure to run above command first on CORE and then on NODE**

### 6. Stop the Hedge stack
Bring down the docker stack
> make down

<br>

#### NOTE: Use the below commands with caution as it deletes all data.

Bring down and wipe clean the Helix IoT stack (removes all containers, volumes, networks etc). \
To avoid accidental runs, a confirmation comes up expecting a "YES" or "NO" response to proceed.

> make force-clean

Remove all docker images from the target machine
```
docker system prune -a
docker images -q | xargs docker rmi -f >/dev/null
```

### 7. Instructions to set up a NODE
Run this command to fetch instructions and secrets for setting up a corresponding Helix Edge NODE

> make get-node-secrets

### 8. Login token for Service Health and configuration management (Consul)
Run this command to get the login token required to login to Consul - for Service Health and Service Configuration management

> make get-consul-token

### 9. Update secrets post-installation
If you need to update any secrets or passwords after the installation is complete, run this command and follow the prompts and instructions

> make update-secrets

**NOTE: Use this with caution as changing critical secrets/passwords may lead to unexpected behavior**

### 10. Troubleshooting
#### * Check logs
> docker logs -f <container-name>


#### * Container specific commands:
    docker container stop $(docker container ls -aq)  	-> To stop all running containers
    docker container rm $(docker container ls -aq)		-> To remove all the stopped containers
    docker rm -f $(docker ps --all -q -f status=dead)   	-> For Deleting all dead containers  		
    docker rm -f $(docker ps --all -q -f status=exited) 	-> For deleting all exited container 
#### * Docker image specific commands:
    docker rmi -f $(docker images -q)	-> To forcefully remove all docker images
    docker images -q			-> To obtain all the images ids
    docker rmi <imageid>    		-> To remove single docker image
#### * Docker volume specific commands:
	docker volume create --name <volume_name> -> to create a new volume
	docker volume ls			  -> list all docker volumes in the system
	docker inspect volume <volume_name>	  -> to get more information about the volume
	docker volume rm <volume_name>		  -> to remove a volume from the system. Containers must be stopped and removed before removing the volume
	docker volume prune			  -> will remove all the volumes not references by any contianers
#### * Docker network specific commands:
	docker network create --name		  -> to create a new docker network
	docker netowrk ls			  -> list all the docker networks
	docker network inspect <network_name>	  -> to get more information about the network
	docker network rm <network_name>	  -> to remove a network.
	docker network prune			  -> to remove all unused networks
	docker network connect <network_name> <container_name>    -> connects the <container_name> to the <network_name> network
	docker network disconnect <network_name> <container_name> -> disconnects <container_name> from the <network_name> network
